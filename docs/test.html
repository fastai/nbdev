---

title: Extract tests


keywords: fastai
sidebar: home_sidebar

summary: "The functions that grab the cells containing tests (filtering with potential flags) and execute them"
description: "The functions that grab the cells containing tests (filtering with potential flags) and execute them"
nb_path: "nbs/04_test.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/04_test.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Everything that is not an exported cell is considered a test, so you should make sure your notebooks can all run smoothly (and fast) if you want to use this functionality as the CLI. You can mark some cells with special flags (like slow) to make sure they are only executed when you authorize it. Those flags should be configured in your <code>settings.ini</code> (separated by a <code>|</code> if you have several of them). You can also apply flags to one entire notebook by using the <code>all</code> option of the test flag, e.g. <code>%nbdev_slow_test all</code>, in code cells.</p>
<p>If <code>tst_flags=slow|fastai</code> in <code>settings.ini</code>, you can:</p>
<ul>
<li>mark slow tests with the <code>%nbdev_slow_test</code> flag</li>
<li>mark tests that depend on fastai with the <code>%nbdev_fastai_test</code> flag.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Detect-flags">Detect flags<a class="anchor-link" href="#Detect-flags"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following functions detect the cells that should be excluded from the tests (unless their special flag is passed).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_all_flags" class="doc_header"><code>get_all_flags</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/test.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_all_flags</code>(<strong><code>cells</code></strong>)</p>
</blockquote>
<p>Check for all test flags in <code>cells</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">nb</span> <span class="o">=</span> <span class="n">read_nb</span><span class="p">(</span><span class="s2">&quot;04_test.ipynb&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">get_all_flags</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_cell_flags" class="doc_header"><code>get_cell_flags</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/test.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_cell_flags</code>(<strong><code>cell</code></strong>)</p>
</blockquote>
<p>Check for any special test flag in <code>cell</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">get_cell_flags</span><span class="p">({</span><span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s2">&quot;%nbdev_hide</span><span class="se">\n</span><span class="s2">%nbdev_fastai_test</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="p">[</span><span class="s1">&#39;fastai&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">get_cell_flags</span><span class="p">({</span><span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s2">&quot;%nbdev_hide</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}),</span> <span class="p">[])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Testing-a-notebook">Testing a notebook<a class="anchor-link" href="#Testing-a-notebook"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NoExportPreprocessor" class="doc_header"><code>class</code> <code>NoExportPreprocessor</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/test.py#L36" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NoExportPreprocessor</code>(<strong>*<code>args</code></strong>, <strong>**<code>kwargs</code></strong>) :: <code>ExecutePreprocessor</code></p>
</blockquote>
<p>An <code>ExecutePreprocessor</code> that executes cells that don't have a flag in <code>flags</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="test_nb" class="doc_header"><code>test_nb</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/test.py#L50" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>test_nb</code>(<strong><code>fn</code></strong>, <strong><code>flags</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Execute tests in notebook in <code>fn</code> with <code>flags</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TestCallbacks</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">begin_test_nb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin_test_nb_data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">nb</span><span class="o">=</span><span class="n">nb</span><span class="p">,</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span><span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nb</span>
    <span class="k">def</span> <span class="nf">after_test_nb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">after_test_nb_data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
<span class="n">test_callbacks</span><span class="o">=</span><span class="n">TestCallbacks</span><span class="p">()</span>
<span class="n">call_cb</span><span class="p">(</span><span class="s1">&#39;this makes sure nbdev_callbacks is loaded from the right place&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">nbdev_callbacks</span>
<span class="n">original_callbacks</span><span class="o">=</span><span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">begin_test_nb</span><span class="p">,</span><span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">after_test_nb</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">begin_test_nb</span><span class="o">=</span><span class="n">test_callbacks</span><span class="o">.</span><span class="n">begin_test_nb</span>
    <span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">after_test_nb</span><span class="o">=</span><span class="n">test_callbacks</span><span class="o">.</span><span class="n">after_test_nb</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_callbacks</span><span class="p">,</span><span class="s1">&#39;begin_test_nb_data&#39;</span><span class="p">)</span>
    <span class="n">expected_file_name</span><span class="p">,</span><span class="n">expected_flags</span><span class="o">=</span><span class="s1">&#39;../test/single-cell-index.ipynb&#39;</span><span class="p">,[</span><span class="s1">&#39;slow&#39;</span><span class="p">,</span><span class="s1">&#39;cuda&#39;</span><span class="p">]</span>
    <span class="n">test_nb</span><span class="p">(</span><span class="n">expected_file_name</span><span class="p">,</span><span class="n">expected_flags</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_callbacks</span><span class="o">.</span><span class="n">begin_test_nb_data</span><span class="p">[</span><span class="s1">&#39;nb&#39;</span><span class="p">][</span><span class="s1">&#39;cells&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">test_callbacks</span><span class="o">.</span><span class="n">begin_test_nb_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_file_name</span>
    <span class="k">assert</span> <span class="n">test_callbacks</span><span class="o">.</span><span class="n">begin_test_nb_data</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_flags</span>
    <span class="k">assert</span> <span class="n">test_callbacks</span><span class="o">.</span><span class="n">after_test_nb_data</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">expected_file_name</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">begin_test_nb</span><span class="p">,</span><span class="n">nbdev_callbacks</span><span class="o">.</span><span class="n">after_test_nb</span><span class="o">=</span><span class="n">original_callbacks</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

