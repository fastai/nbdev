---

title: Fix merge conflicts


keywords: fastai
sidebar: home_sidebar

summary: "Fix merge conflicts in jupyter notebooks"
description: "Fix merge conflicts in jupyter notebooks"
nb_path: "nbs/05_merge.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_merge.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When working with jupyter notebooks (which are json files behind the scenes) and GitHub, it is very common that a merge conflict (that will add new lines in the notebook source file) will break some notebooks you are working on. This module defines the function <code>fix_conflicts</code> to fix those notebooks for you, and attempt to automatically merge standard conflicts. The remaining ones will be delimited by markdown cells like this:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include image.html alt="Fixed notebook" width="700" caption="A notebook fixed after a merged conflict. The file couldn't be opened before the command was run, but after it the conflict is highlighted by markdown cells." max-width="700" file="/images/merge.PNG" %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Walk-cells">Walk cells<a class="anchor-link" href="#Walk-cells"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is an example of broken notebook we defined in <code>tst_nb</code>. The json format is broken by the lines automatically added by git. Such a file can't be opened again in jupyter notebook, leaving the user with no other choice than to fix the text file manually.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tst_nb</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{
 &#34;cells&#34;: [
  {
   &#34;cell_type&#34;: &#34;code&#34;,
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
   &#34;execution_count&#34;: 6,
   &#34;metadata&#34;: {},
   &#34;outputs&#34;: [
    {
     &#34;data&#34;: {
      &#34;text/plain&#34;: [
       &#34;3&#34;
      ]
     },
     &#34;execution_count&#34;: 6,
     &#34;metadata&#34;: {},
     &#34;output_type&#34;: &#34;execute_result&#34;
    }
   ],
   &#34;source&#34;: [
    &#34;z=3
&#34;,
    &#34;z&#34;
   ]
  },
  {
   &#34;cell_type&#34;: &#34;code&#34;,
   &#34;execution_count&#34;: 7,
=======
   &#34;execution_count&#34;: 5,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; a7ec1b0bfb8e23b05fd0a2e6cafcb41cd0fb1c35
   &#34;metadata&#34;: {},
   &#34;outputs&#34;: [
    {
     &#34;data&#34;: {
      &#34;text/plain&#34;: [
       &#34;6&#34;
      ]
     },
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD
     &#34;execution_count&#34;: 7,
=======
     &#34;execution_count&#34;: 5,
&gt;&gt;&gt;&gt;&gt;&gt;&gt; a7ec1b0bfb8e23b05fd0a2e6cafcb41cd0fb1c35
     &#34;metadata&#34;: {},
     &#34;output_type&#34;: &#34;execute_result&#34;
    }
   ],
   &#34;source&#34;: [
    &#34;x=3
&#34;,
    &#34;y=3
&#34;,
    &#34;x+y&#34;
   ]
  },
  {
   &#34;cell_type&#34;: &#34;code&#34;,
   &#34;execution_count&#34;: null,
   &#34;metadata&#34;: {},
   &#34;outputs&#34;: [],
   &#34;source&#34;: []
  }
 ],
 &#34;metadata&#34;: {
  &#34;kernelspec&#34;: {
   &#34;display_name&#34;: &#34;Python 3&#34;,
   &#34;language&#34;: &#34;python&#34;,
   &#34;name&#34;: &#34;python3&#34;
  }
 },
 &#34;nbformat&#34;: 4,
 &#34;nbformat_minor&#34;: 2
}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that in this example, the second conflict is easily solved: it just concerns the execution count of the second cell and can be solved by choosing either option without really impacting your notebook. This is the kind of conflicts <code>fix_conflicts</code> will (by default) fix automatically. The first conflict is more complicated as it spans across two cells and there is a cell present in one version, not the other. Such a conflict (and generally the ones where the inputs of the cells change form one version to the other) aren't automatically fixed, but <code>fix_conflicts</code> will return a proper json file where the annotations introduced by git will be placed in markdown cells.</p>
<p>The first step to do this is to walk the raw text file to extract the cells. We can't read it as a JSON since it's broken, so we have to parse the text.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_cells" class="doc_header"><code>extract_cells</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/merge.py#L10" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_cells</code>(<strong><code>raw_txt</code></strong>)</p>
</blockquote>
<p>Manually extract cells in potential broken json <code>raw_txt</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This function returns the beginning of the text (before the cells are defined), the list of cells and the end of the text (after the cells are defined).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">start</span><span class="p">,</span><span class="n">cells</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="n">extract_cells</span><span class="p">(</span><span class="n">tst_nb</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;&quot;&quot;  {</span>
<span class="s2">   &quot;cell_type&quot;: &quot;code&quot;,</span>
<span class="s2">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span>
<span class="s2">   &quot;execution_count&quot;: 6,</span>
<span class="s2">   &quot;metadata&quot;: </span><span class="si">{}</span><span class="s2">,</span>
<span class="s2">   &quot;outputs&quot;: [</span>
<span class="s2">    {</span>
<span class="s2">     &quot;data&quot;: {</span>
<span class="s2">      &quot;text/plain&quot;: [</span>
<span class="s2">       &quot;3&quot;</span>
<span class="s2">      ]</span>
<span class="s2">     },</span>
<span class="s2">     &quot;execution_count&quot;: 6,</span>
<span class="s2">     &quot;metadata&quot;: </span><span class="si">{}</span><span class="s2">,</span>
<span class="s2">     &quot;output_type&quot;: &quot;execute_result&quot;</span>
<span class="s2">    }</span>
<span class="s2">   ],</span>
<span class="s2">   &quot;source&quot;: [</span>
<span class="s2">    &quot;z=3</span><span class="se">\n</span><span class="s2">&quot;,</span>
<span class="s2">    &quot;z&quot;</span>
<span class="s2">   ]</span>
<span class="s2">  },&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When walking the broken cells, we will add conflicts marker before and after the cells with conflicts as markdown cells. To do that we use this function.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_md_cell" class="doc_header"><code>get_md_cell</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/merge.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_md_cell</code>(<strong><code>txt</code></strong>)</p>
</blockquote>
<p>A markdown cell with <code>txt</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;  {</span>
<span class="s1">   &quot;cell_type&quot;: &quot;markdown&quot;,</span>
<span class="s1">   &quot;metadata&quot;: </span><span class="si">{}</span><span class="s1">,</span>
<span class="s1">   &quot;source&quot;: [</span>
<span class="s1">    &quot;A bit of markdown&quot;</span>
<span class="s1">   ]</span>
<span class="s1">  },&#39;&#39;&#39;</span>
<span class="k">assert</span> <span class="n">get_md_cell</span><span class="p">(</span><span class="s2">&quot;A bit of markdown&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">tst</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="same_inputs" class="doc_header"><code>same_inputs</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/merge.py#L60" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>same_inputs</code>(<strong><code>t1</code></strong>, <strong><code>t2</code></strong>)</p>
</blockquote>
<p>Test if the cells described in <code>t1</code> and <code>t2</code> have the same inputs</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;&#39;  {</span>
<span class="s1">   &quot;cell_type&quot;: &quot;code&quot;,</span>
<span class="s1">   &quot;source&quot;: [</span>
<span class="s1">    &quot;&#39;&#39;&#39;</span><span class="o">+</span><span class="n">code</span><span class="o">+</span><span class="s1">&#39;&#39;&#39;&quot;</span>
<span class="s1">   ]</span>
<span class="s1">  },&#39;&#39;&#39;</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;a=1&quot;</span><span class="p">,</span> <span class="s2">&quot;b=1&quot;</span><span class="p">,</span>  <span class="s2">&quot;a=1&quot;</span><span class="p">]]</span>
<span class="k">assert</span> <span class="n">same_inputs</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="k">assert</span> <span class="ow">not</span> <span class="n">same_inputs</span><span class="p">(</span><span class="n">ts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="analyze_cell" class="doc_header"><code>analyze_cell</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/merge.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>analyze_cell</code>(<strong><code>cell</code></strong>, <strong><code>cf</code></strong>, <strong><code>names</code></strong>, <strong><code>prev</code></strong>=<em><code>None</code></em>, <strong><code>added</code></strong>=<em><code>False</code></em>, <strong><code>fast</code></strong>=<em><code>True</code></em>, <strong><code>trust_us</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Analyze and solve conflicts in <code>cell</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is the main function used to walk through the cells of a notebook. <code>cell</code> is the cell we're at, <code>cf</code> the conflict state: <code>0</code> if we're not in any conflict, <code>1</code> if we are inside the first part of a conflict (between <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> and <code>=======</code>) and <code>2</code> for the second part of a conflict. <code>names</code> contains the names of the branches (they start at <code>[None,None]</code> and get updated as we pass along conflicts). <code>prev</code> contains a copy of what should be included at the start of the second version (if <code>cf=1</code> or <code>cf=2</code>). <code>added</code> starts at <code>False</code> and keeps track of whether we added any markdown cells (this flag allows us to know if a fast merge didn't leave any conflicts at the end). <code>fast</code> and <code>trust_us</code> are passed along by <code>fix_conflicts</code>: if <code>fast</code> is <code>True</code>, we don't point out conflict between cells if the inputs in the two versions are the same. Instead we merge using the local or remote branch, depending on <code>trust_us</code>.</p>
<p>The function then returns the updated text (with one or several cells, depending on the conflicts to solve), the updated <code>cf</code>, <code>names</code>, <code>prev</code> and <code>added</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">conflicts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">c</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">prev</span><span class="p">,</span><span class="n">added</span> <span class="o">=</span> <span class="n">analyze_cell</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span><span class="n">fast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">get_md_cell</span><span class="p">(</span><span class="s1">&#39;`&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD`&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">a</span><span class="se">\n</span><span class="s1">b&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">prev</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;a</span><span class="se">\n</span><span class="s1">c&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">added</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here in this example, we were entering cell <code>tst</code> with no conflict state. At the end of the cells, we are still in the second part of the conflict, hence <code>cf=2</code>. The result returns a marker for the branch head, then the whole cell in version 1 (a + b). We save a (prior to the conflict hence common to the two versions) and c (only in version 2) for the next cell in <code>prev</code> (that should contain the resolution of this conflict).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Main-function">Main function<a class="anchor-link" href="#Main-function"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nbdev_fix_merge" class="doc_header"><code>nbdev_fix_merge</code><a href="https://github.com/fastai/nbdev/tree/master/nbdev/merge.py#L92" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nbdev_fix_merge</code>(<strong><code>fname</code></strong>:"A notebook filename to fix", <strong><code>fast</code></strong>:"Fast fix: automatically fix the merge conflicts in outputs or metadata"=<em><code>True</code></em>, <strong><code>trust_us</code></strong>:"Use local outputs/metadata when fast merging"=<em><code>True</code></em>)</p>
</blockquote>
<p>Fix merge conflicts in notebook <code>fname</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This begins by backing the notebook <code>fname</code> to <code>fname.bak</code> in case something goes wrong. Then it parses the broken json, solving conflicts in cells. If <code>fast=True</code>, every conflict that only involves metadata or outputs of cells will be solved automatically by using the local (<code>trust_us=True</code>) or the remote (<code>trust_us=False</code>) branch. Otherwise, or for conflicts involving the inputs of cells, the json will be repaired by including the two version of the conflicted cell(s) with markdown cells indicating the conflicts. You will be able to open the notebook again and search for the conflicts (look for <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code>) then fix them as you wish.</p>
<p>If <code>fast=True</code>, the function will print a message indicating whether the notebook was fully merged or if conflicts remain.</p>

</div>
</div>
</div>
</div>
 

